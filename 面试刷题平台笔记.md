# é¢è¯•åˆ·é¢˜å¹³å°ç¬”è®°

## æ‰¹å¤„ç†ä¼˜åŒ–

â€‹	**å¥å£®æ€§**

â€‹			1.æå‰çš„å‚æ•°æ ¡éªŒ , å¼‚å¸¸æˆ–è€…ä¸åˆæ³•æƒ…å†µ

â€‹			2.èƒ½é‡è§çš„ä»£ç å¼‚å¸¸å¤„ç†

â€‹    **ç¨³å®šæ€§**

â€‹			1.é¿å…é•¿äº‹åŠ¡ , æ¯”å¦‚10wæ¡æ•°æ® , åˆ†ä¸º1000ä¸€æ‰¹ , åˆ†æ‰¹å­˜å‚¨ , å¦‚æœæœ‰é—®é¢˜åªå›æ»šæœ‰é—®é¢˜çš„ä¸€æ‰¹ , ä¸ä¼šä¸€æ¬¡æ€§å›æ»š10wæ¡æ•°æ®

â€‹			2.é‡è¯• : å¹¶ç»™å‡ºé‡è¯•ä¸Šé™çš„æ¬¡æ•° , ä¸€èˆ¬ä¸º3æ¬¡ , æˆ–è€…ä½¿ç”¨ Guava Retrying åº“  https://cloud.tencent.com/developer/article/1752086

â€‹		ä¸­æ–­æ¢å¤ : ä¸ºæ‰¹æ¬¡æ‰“ä¸Šæ ‡è®°,  å¦‚æœå‡ºç°å¼‚å¸¸ , ä¸‹æ¬¡å¯ä»¥ä»å¤±è´¥çš„åœ°æ–¹ç»§ç»­å¼€å§‹

â€‹	**æ€§èƒ½ä¼˜åŒ–**

â€‹			1.æ•°æ®æ‰¹é‡æ’å…¥ saveBatch mybatisPlusæ¡†æ¶è‡ªå¸¦

â€‹			2.SQLä¼˜åŒ– 

â€‹			3.å¹¶å‘ç¼–ç¨‹ åˆ©ç”¨å¹¶å‘åŒ…ä¸­çš„ **CompletableFuture + çº¿ç¨‹æ± ** æ¥å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡			

```
	CompletableFuâ€ture é»˜è®¤ä½¿ç”¨ Java 7 å¼•å…¥çš„ Forkï»¿JoinPool çº¿ç¨‹æ± æ¥å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚è¯¥çº¿ç¨‹æ± ç‰¹ï»¿åˆ«é€‚åˆéœ€è¦åˆ†æ²»æ³•æ¥å¤„ç†çš„å¤§é‡å¹¶å‘ä»»åŠ¡ï¼Œæ”¯æŒé€’å½’ä»»â¢åŠ¡æ‹†åˆ†ã€‚Java 8 ä¸­çš„å¹¶è¡Œæµé»˜è®¤ä¹Ÿæ˜¯ä½¿ç”¨äº† Foâ¢rkJoinPool è¿›è¡Œå¹¶å‘å¤„ç†

ForkJoinPool çš„ä¸»è¦ç‰¹æ€§ï¼š
	å·¥ä½œçªƒå–ç®—æ³•ï¼ˆWork-Stealingï¼‰ï¼šçº¿ç¨‹å¯ä»¥ä»å…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ä¸­â€œçªƒå–â€ä»»åŠ¡ï¼Œä»¥æé«˜ CPU çš„ä½¿ç”¨ç‡å’Œç¨‹åºçš„å¹¶è¡Œæ€§ã€‚
	é€’å½’ä»»åŠ¡å¤„ç†ï¼šæ”¯æŒå°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œç„¶åå†å°†ç»“æœåˆå¹¶
	
	ğŸ’¡ ä½†æ˜¯è¦æ³¨æ„ï¼ŒCompletableFuture é»˜è®¤ä½¿ç”¨çš„æ˜¯ ForkJoinPool.commonPool() æ–¹æ³•å¾—åˆ°çš„çº¿ç¨‹æ± ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€å…±äº«çš„çº¿ç¨‹æ± ï¼Œå¦‚æœæœ‰å¤šç§ä¸åŒçš„ä»»åŠ¡éƒ½ä¾èµ–è¯¥çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºäº‰æŠ¢ã€ä»£ç é˜»å¡ç­‰ä¸ç¡®å®šçš„é—®é¢˜ã€‚æ‰€ä»¥å»ºè®®é’ˆå¯¹æ¯ç§ä»»åŠ¡ï¼Œè‡ªå®šä¹‰çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œå®ç°çº¿ç¨‹æ± èµ„æºçš„éš”ç¦»ã€‚
```

â€‹			4.å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–

â€‹				1)	ç«‹å³æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡  Spring æä¾›çš„ `@Async` æ³¨è§£

â€‹				2ï¼‰  å®šæ—¶æ‰§è¡Œ   Spring Scheduler å®šæ—¶ä»»åŠ¡æŒç»­æ‰«ææ•°æ®åº“ä¸­ æœªæ‰§è¡Œçš„ä»»åŠ¡ 

â€‹				3ï¼‰é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œä»»åŠ¡åˆ†å‘  è¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ RabbitMQã€Kafkaï¼‰æ¥å¼‚æ­¥å¤„ç†ä»»åŠ¡

â€‹			5.æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

â€‹		**æ•°æ®ä¸€è‡´æ€§**

â€‹			1.äº‹åŠ¡ç®¡ç†   @Transactional(rollbackFor = Exception.class)

â€‹			2.å¹¶å‘ç®¡ç†   Redisson å®ç°åˆ†å¸ƒå¼é”   /   ä¹è§‚é”(åŠ ç‰ˆæœ¬å·) /  SELECT ... FOR UPDATE

â€‹	 **å¯è§‚æµ‹æ€§**

â€‹			  1.æ—¥å¿—è®°å½•   å¤šæ‰“log

â€‹			  2.ç›‘æ§ Elï»¿asticsearch å¯ä»¥é€šè¿‡ Kibana ç›‘æ§ç­‰ç­‰â¢ã€Spring Boot å†…ç½®äº† Spring Bootâ¢ Actuator æ¥ç›‘æ§åº”ç”¨è¿è¡ŒçŠ¶æ€ç­‰ã€‚



â€‹	

## çŸ¥è¯†ç‚¹ :

### 1.Spring äº‹åŠ¡ä¾èµ–äºä»£ç†æœºåˆ¶

è€Œå†…éƒ¨è°ƒç”¨é€šè¿‡ `this` ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œä¸ä¼šé€šè¿‡ Spring çš„ä»£ç†ï¼Œå› æ­¤ä¸ä¼šè§¦å‘äº‹åŠ¡ã€‚é€šè¿‡ `AopContext.currentProxy()` æ–¹æ³•è·å–åˆ°äº†å½“å‰å®ç°ç±»çš„ä»£ç†å¯¹è±¡ï¼Œæ¥è°ƒç”¨äº‹åŠ¡æ–¹æ³•ã€‚

æ³¨æ„ï¼Œä½¿ç”¨ `AopContext.currentProxy()` æ–¹æ³•æ—¶å¿…é¡»è¦åœ¨å¯åŠ¨ç±»æ·»åŠ ä¸‹é¢çš„æ³¨è§£å¼€å¯åˆ‡é¢è‡ªåŠ¨ä»£ç†ï¼š

```java
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
```

```javascript
@Override
    public void batchAddQuestionsToBank(List<Long> questionIdList, long questionBankId, User loginUser) {
        .... ä¸šåŠ¡é€»è¾‘
        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é•¿äº‹åŠ¡ï¼Œå‡è®¾æ¯æ¬¡å¤„ç† 1000 æ¡æ•°æ®
        int batchSize = 1000;
        int totalQuestionListSize = validQuestionIdList.size();
        for (int i = 0; i < totalQuestionListSize; i += batchSize) {
            // ç”Ÿæˆæ¯æ‰¹æ¬¡çš„æ•°æ®
            List<Long> subList = validQuestionIdList.subList(i, Math.min(i + batchSize, totalQuestionListSize));
            List<QuestionBankQuestion> questionBankQuestions = subList.stream()
                    ...ä¸šåŠ¡é€»è¾‘
                    }).collect(Collectors.toList());
            // ä½¿ç”¨äº‹åŠ¡å¤„ç†æ¯æ‰¹æ•°æ®
            // è·å–ä»£ç†
            QuestionBankQuestionService questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();
            //è°ƒç”¨			                         	  questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
        }
    }

@Override
    @Transactional(rollbackFor = Exception.class)
    public void batchAddQuestionsToBankInner(List<QuestionBankQuestion> questionBankQuestions) {
        try {
            boolean result = this.saveBatch(questionBankQuestions);
        } catch {
            ...ä¸šåŠ¡é€»è¾‘
        }
    }
```

### 2.é‡è¯•ä»£ç    Guava Retrying åº“

 Guava Retrying åº“  https://cloud.tencent.com/developer/article/1752086

```javascript
int retryCount = 3;
for (int i = 0; i < retryCount; i++) {
    try {
        // æ‰§è¡Œæ’å…¥æ“ä½œ
        // æˆåŠŸåˆ™è·³å‡ºé‡è¯•å¾ªç¯
        break; 
    } catch (Exception e) {
        log.warn("æ’å…¥å¤±è´¥ï¼Œé‡è¯•æ¬¡æ•°: {}", i + 1);
        if (i == retryCount - 1) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å¤šæ¬¡é‡è¯•åæ“ä½œä»ç„¶å¤±è´¥");
        }
    }
}


 Guava Retrying åº“  https://cloud.tencent.com/developer/article/1752086
```

### 3.å¹¶å‘ç¼–ç¨‹ä»£ç   

CompletableFuture + è‡ªå®šä¹‰çº¿ç¨‹æ± 

```javascript
/**
     * æ‰¹é‡æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“
     *
     * @param questionIdList
     * @param questionBankId
     * @param loginUser
     */
    @Override
    public void batchAddQuestionsToBank(List<Long> questionIdList, long questionBankId, User loginUser) {
        // å‚æ•°æ ¡éªŒ
        ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, "é¢˜ç›®åˆ—è¡¨ä¸èƒ½ä¸ºç©º");
        ThrowUtils.throwIf(questionBankId <= 0, ErrorCode.PARAMS_ERROR, "é¢˜åº“ id éæ³•");
        ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);
        // æ£€æŸ¥é¢˜ç›® id æ˜¯å¦å­˜åœ¨
        LambdaQueryWrapper<Question> questionLambdaQueryWrapper = Wrappers.lambdaQuery(Question.class)
                .select(Question::getId)
                .in(Question::getId, questionIdList);
        // åˆæ³•çš„é¢˜ç›® id åˆ—è¡¨
        List<Long> validQuestionIdList = questionService.listObjs(questionLambdaQueryWrapper, obj -> (Long) obj);
        ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, "åˆæ³•çš„é¢˜ç›® id åˆ—è¡¨ä¸ºç©º");
        // æ£€æŸ¥å“ªäº›é¢˜ç›®è¿˜ä¸å­˜åœ¨äºé¢˜åº“ä¸­ï¼Œé¿å…é‡å¤æ’å…¥
        LambdaQueryWrapper<QuestionBankQuestion> lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)
                .eq(QuestionBankQuestion::getQuestionBankId, questionBankId)
                .in(QuestionBankQuestion::getQuestionId, validQuestionIdList);
        List<QuestionBankQuestion> existQuestionList = this.list(lambdaQueryWrapper);
        // å·²å­˜åœ¨äºé¢˜åº“ä¸­çš„é¢˜ç›® id
        Set<Long> existQuestionIdSet = existQuestionList.stream()
                .map(QuestionBankQuestion::getId)
                .collect(Collectors.toSet());
        // å·²å­˜åœ¨äºé¢˜åº“ä¸­çš„é¢˜ç›® idï¼Œä¸éœ€è¦å†æ¬¡æ·»åŠ 
        validQuestionIdList = validQuestionIdList.stream().filter(questionId -> {
            return !existQuestionIdSet.contains(questionId);
        }).collect(Collectors.toList());
        ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, "æ‰€æœ‰é¢˜ç›®éƒ½å·²å­˜åœ¨äºé¢˜åº“ä¸­");
        // æ£€æŸ¥é¢˜åº“ id æ˜¯å¦å­˜åœ¨
        QuestionBank questionBank = questionBankService.getById(questionBankId);
        ThrowUtils.throwIf(questionBank == null, ErrorCode.NOT_FOUND_ERROR, "é¢˜åº“ä¸å­˜åœ¨");

        // è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆIO å¯†é›†å‹çº¿ç¨‹æ± ï¼‰
        ThreadPoolExecutor customExecutor = new ThreadPoolExecutor(
                20,             // æ ¸å¿ƒçº¿ç¨‹æ•°
                50,                        // æœ€å¤§çº¿ç¨‹æ•°
                60L,                       // çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´
                TimeUnit.SECONDS,           // å­˜æ´»æ—¶é—´å•ä½
                new LinkedBlockingQueue<>(10000),  // é˜»å¡é˜Ÿåˆ—å®¹é‡
                new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ä»»åŠ¡
        );

        // ä¿å­˜æ‰€æœ‰æ‰¹æ¬¡ä»»åŠ¡
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é•¿äº‹åŠ¡ï¼Œå‡è®¾æ¯æ¬¡å¤„ç† 1000 æ¡æ•°æ®
        int batchSize = 1000;
        int totalQuestionListSize = validQuestionIdList.size();
        for (int i = 0; i < totalQuestionListSize; i += batchSize) {
            // ç”Ÿæˆæ¯æ‰¹æ¬¡çš„æ•°æ®
            List<Long> subList = validQuestionIdList.subList(i, Math.min(i + batchSize, totalQuestionListSize));
            List<QuestionBankQuestion> questionBankQuestions = subList.stream()
                    .map(questionId -> {
                        QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();
                        questionBankQuestion.setQuestionBankId(questionBankId);
                        questionBankQuestion.setQuestionId(questionId);
                        questionBankQuestion.setUserId(loginUser.getId());
                        return questionBankQuestion;
                    }).collect(Collectors.toList());
            // ä½¿ç”¨äº‹åŠ¡å¤„ç†æ¯æ‰¹æ•°æ®
            // è·å–ä»£ç†
            QuestionBankQuestionService questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();

            // å¼‚æ­¥å¤„ç†æ¯æ‰¹æ•°æ®ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ°å¼‚æ­¥ä»»åŠ¡åˆ—è¡¨
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
            }, customExecutor);
            futures.add(future);
        }
        // ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å®Œæˆæ“ä½œ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
        // å…³é—­çº¿ç¨‹æ± 
        customExecutor.shutdown();
    }

    /**
     * æ‰¹é‡æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“ï¼ˆäº‹åŠ¡ï¼Œä»…ä¾›å†…éƒ¨è°ƒç”¨ï¼‰
     *
     * @param questionBankQuestions
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void batchAddQuestionsToBankInner(List<QuestionBankQuestion> questionBankQuestions) {
        try {
            boolean result = this.saveBatch(questionBankQuestions);
            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
        } catch (DataIntegrityViolationException e) {
            log.error("æ•°æ®åº“å”¯ä¸€é”®å†²çªæˆ–è¿åå…¶ä»–å®Œæ•´æ€§çº¦æŸ, é”™è¯¯ä¿¡æ¯: {}", e.getMessage());
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "é¢˜ç›®å·²å­˜åœ¨äºè¯¥é¢˜åº“ï¼Œæ— æ³•é‡å¤æ·»åŠ ");
        } catch (DataAccessException e) {
            log.error("æ•°æ®åº“è¿æ¥é—®é¢˜ã€äº‹åŠ¡é—®é¢˜ç­‰å¯¼è‡´æ“ä½œå¤±è´¥, é”™è¯¯ä¿¡æ¯: {}", e.getMessage());
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ•°æ®åº“æ“ä½œå¤±è´¥");
        } catch (Exception e) {
            // æ•è·å…¶ä»–å¼‚å¸¸ï¼Œåšé€šç”¨å¤„ç†
            log.error("æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯: {}", e.getMessage());
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");
        }
    }
```

æ³¨æ„ï¼Œè™½ç„¶å¹¶å‘ç¼–ç¨‹èƒ½å¤Ÿæå‡æ€§èƒ½ï¼Œä½†ä¹Ÿä¼šå ç”¨æ›´å¤šçš„èµ„æºï¼Œå¹¶ä¸”ç»™ç³»ç»Ÿå¼•å…¥æ›´å¤šçš„ä¸ç¡®å®šæ€§ã€‚æ¯”å¦‚æŸä¸ªä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œå…¶ä»–ä»»åŠ¡å¯èƒ½æ­£åœ¨æ‰§è¡Œï¼Œäº§ç”Ÿä¸ç¡®å®šçš„å½±å“ã€‚å¯¹æ­¤ï¼Œå¯ä»¥æ ¹æ®æƒ…å†µç»™å¼‚æ­¥ä»»åŠ¡è¡¥å……å¼‚å¸¸å¤„ç†è¡Œä¸ºï¼Œé€šè¿‡ `exceptionally` æ–¹æ³•å°±èƒ½å®ç°ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```javascript
CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
    questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);
}, customExecutor).exceptionally(ex -> {
    log.error("æ‰¹å¤„ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", ex);
    return null;
});
```



### 4.æ•°æ®åº“è¿æ¥æ± è°ƒä¼˜  Druid

1ï¼‰é€šè¿‡ â€Maven å¼•å…¥ ï»¿Druidï¼Œå¹¶ä¸”æ’ï»¿é™¤é»˜è®¤å¼•å…¥çš„ Hiâ¢kariCPï¼š

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.2.23</version>
</dependency>

<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.2.2</version>
    <exclusions>
        <!-- æ’é™¤é»˜è®¤çš„ HikariCP -->
        <exclusion>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

2ï¼‰ä¿®æ”¹ application.yml æ–‡ä»¶é…ç½®ã€‚

ç”±äºå‚æ•°è¾ƒâ€å¤šï¼Œå»ºè®®ç›´æ¥æ‹·è´ä»¥ï»¿ä¸‹é…ç½®å³å¯ï¼Œéƒ¨åˆ†å‚ï»¿æ•°å¯ä»¥æ ¹æ®æ³¨é‡Šè‡ªè¡Œâ¢è°ƒæ•´ï¼š

```yaml
spring:
  # æ•°æ®æºé…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/mianshiya
    username: root
    password: 123456
    # æŒ‡å®šæ•°æ®æºç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # Druid é…ç½®
    druid:
      # é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§
      initial-size: 10
      minIdle: 10
      max-active: 10
      # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
      max-wait: 60000
      # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’
      time-between-eviction-runs-millis: 2000
      # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
      min-evictable-idle-time-millis: 600000
      max-evictable-idle-time-millis: 900000
      # ç”¨æ¥æµ‹è¯•è¿æ¥æ˜¯å¦å¯ç”¨çš„SQLè¯­å¥,é»˜è®¤å€¼æ¯ç§æ•°æ®åº“éƒ½ä¸ç›¸åŒ,è¿™æ˜¯mysql
      validationQuery: select 1
      # åº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥ï¼Œå¹¶ä¸”testOnBorrowä¸ºfalseæ—¶ï¼Œè¿æ¥æ± å°†ä¼šåˆ¤æ–­è¿æ¥æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éªŒè¯è¿™æ¡è¿æ¥æ˜¯å¦å¯ç”¨
      testWhileIdle: true
      # å¦‚æœä¸ºtrueï¼Œé»˜è®¤æ˜¯falseï¼Œåº”ç”¨å‘è¿æ¥æ± ç”³è¯·è¿æ¥æ—¶ï¼Œè¿æ¥æ± ä¼šåˆ¤æ–­è¿™æ¡è¿æ¥æ˜¯å¦æ˜¯å¯ç”¨çš„
      testOnBorrow: false
      # å¦‚æœä¸ºtrueï¼ˆé»˜è®¤falseï¼‰ï¼Œå½“åº”ç”¨ä½¿ç”¨å®Œè¿æ¥ï¼Œè¿æ¥æ± å›æ”¶è¿æ¥çš„æ—¶å€™ä¼šåˆ¤æ–­è¯¥è¿æ¥æ˜¯å¦è¿˜å¯ç”¨
      testOnReturn: false
      # æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheã€‚PSCacheå¯¹æ”¯æŒæ¸¸æ ‡çš„æ•°æ®åº“æ€§èƒ½æå‡å·¨å¤§ï¼Œæ¯”å¦‚è¯´oracle
      poolPreparedStatements: true
      # è¦å¯ç”¨PSCacheï¼Œå¿…é¡»é…ç½®å¤§äº0ï¼Œå½“å¤§äº0æ—¶ï¼Œ poolPreparedStatementsè‡ªåŠ¨è§¦å‘ä¿®æ”¹ä¸ºtrueï¼Œ
      # åœ¨Druidä¸­ï¼Œä¸ä¼šå­˜åœ¨Oracleä¸‹PSCacheå ç”¨å†…å­˜è¿‡å¤šçš„é—®é¢˜ï¼Œ
      # å¯ä»¥æŠŠè¿™ä¸ªæ•°å€¼é…ç½®å¤§ä¸€äº›ï¼Œæ¯”å¦‚è¯´100
      maxOpenPreparedStatements: 20
      # è¿æ¥æ± ä¸­çš„minIdleæ•°é‡ä»¥å†…çš„è¿æ¥ï¼Œç©ºé—²æ—¶é—´è¶…è¿‡minEvictableIdleTimeMillisï¼Œåˆ™ä¼šæ‰§è¡ŒkeepAliveæ“ä½œ
      keepAlive: true
      # Spring ç›‘æ§ï¼Œåˆ©ç”¨aop å¯¹æŒ‡å®šæ¥å£çš„æ‰§è¡Œæ—¶é—´ï¼Œjdbcæ•°è¿›è¡Œè®°å½•
      aop-patterns: "com.springboot.template.dao.*"
      ########### å¯ç”¨å†…ç½®è¿‡æ»¤å™¨ï¼ˆç¬¬ä¸€ä¸ª stat å¿…é¡»ï¼Œå¦åˆ™ç›‘æ§ä¸åˆ°SQLï¼‰##########
      filters: stat,wall,log4j2
      # è‡ªå·±é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filter
      filter:
        # å¼€å¯druiddatasourceçš„çŠ¶æ€ç›‘æ§
        stat:
          enabled: true
          db-type: mysql
          # å¼€å¯æ…¢sqlç›‘æ§ï¼Œè¶…è¿‡2s å°±è®¤ä¸ºæ˜¯æ…¢sqlï¼Œè®°å½•åˆ°æ—¥å¿—ä¸­
          log-slow-sql: true
          slow-sql-millis: 2000
        # æ—¥å¿—ç›‘æ§ï¼Œä½¿ç”¨slf4j è¿›è¡Œæ—¥å¿—è¾“å‡º
        slf4j:
          enabled: true
          statement-log-error-enabled: true
          statement-create-after-log-enabled: false
          statement-close-after-log-enabled: false
          result-set-open-after-log-enabled: false
          result-set-close-after-log-enabled: false
      ########## é…ç½®WebStatFilterï¼Œç”¨äºé‡‡é›†webå…³è”ç›‘æ§çš„æ•°æ® ##########
      web-stat-filter:
        enabled: true                   # å¯åŠ¨ StatFilter
        url-pattern: /* # è¿‡æ»¤æ‰€æœ‰url
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*" # æ’é™¤ä¸€äº›ä¸å¿…è¦çš„url
        session-stat-enable: true       # å¼€å¯sessionç»Ÿè®¡åŠŸèƒ½
        session-stat-max-count: 1000 # sessionçš„æœ€å¤§ä¸ªæ•°,é»˜è®¤100
      ########## é…ç½®StatViewServletï¼ˆç›‘æ§é¡µé¢ï¼‰ï¼Œç”¨äºå±•ç¤ºDruidçš„ç»Ÿè®¡ä¿¡æ¯ ##########
      stat-view-servlet:
        enabled: true                   # å¯ç”¨StatViewServlet
        url-pattern: /druid/* # è®¿é—®å†…ç½®ç›‘æ§é¡µé¢çš„è·¯å¾„ï¼Œå†…ç½®ç›‘æ§é¡µé¢çš„é¦–é¡µæ˜¯/druid/index.html
        reset-enable: false              # ä¸å…è®¸æ¸…ç©ºç»Ÿè®¡æ•°æ®,é‡æ–°è®¡ç®—
        login-username: root # é…ç½®ç›‘æ§é¡µé¢è®¿é—®å¯†ç 
        login-password: 123
        allow: 127.0.0.1 # å…è®¸è®¿é—®çš„åœ°å€ï¼Œå¦‚æœallowæ²¡æœ‰é…ç½®æˆ–è€…ä¸ºç©ºï¼Œåˆ™å…è®¸æ‰€æœ‰è®¿é—®
        deny: # æ‹’ç»è®¿é—®çš„åœ°å€ï¼Œdenyä¼˜å…ˆäºallowï¼Œå¦‚æœåœ¨denyåˆ—è¡¨ä¸­ï¼Œå°±ç®—åœ¨allowåˆ—è¡¨ä¸­ï¼Œä¹Ÿä¼šè¢«æ‹’ç»

```

3ï¼‰å¯åŠ¨åè®¿é—®ç›‘æ§é¢æ¿ï¼š<http://localhost:8101/api/druid/index.html>

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/yPI7flpqvPZhAjfw.webp)

é™¤äº† SQL çš„ç›‘â€æ§ï¼Œè¿˜æœ‰ URI çš„ç›‘æ§ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ï»¿å“ªä¸ªæ¥å£è°ƒç”¨äº†æ•°æ®åº“ï¼Œæ‰§è¡Œäº†å¤šå°‘ï»¿æ—¶é—´ã€‚ä»¥åå‡ºç°çº¿ä¸Šæ•°æ®åº“å¡æ­»çš„é—®é¢˜æ—¶ï¼Œå¾ˆâ¢å¿«å°±èƒ½å®šä½åˆ°æ˜¯å“ªä¸ªæ¥å£ã€å“ªä¸ª SQLâ¢ å‡ºç°äº†é—®é¢˜ï¼ˆæˆ–è€…è®¿é—®é¢‘ç‡è¿‡é«˜ï¼‰ã€‚

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/UGup5aUW2K9NSIvx.webp)

### 5.è‡ªåŠ¨ç¼“å­˜çƒ­ç‚¹æ•°æ®  hotkey

äº¬ä¸œæä¾›äº†ä¸€ä¸ªè½»é‡çº§é€šç”¨çš„çƒ­ key æ¢æµ‹ä¸­é—´ä»¶ [hotkey](https://gitee.com/jd-platform-opensource/hotkey)ã€‚

å¼•å…¥ hotkey  [æœ¬åœ°jaråŒ…](D:\ä¸ªäººç¬”è®°\sum-up\JaråŒ…\hotKey)

æœ¬åœ°ä½¿ç”¨æ”¾åˆ°é¡¹ç›®ä¸­libç›®å½•ä¸‹å³å¯

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/8tTBIow4QgwYvcPF.webp)

```xml
<dependency>
  <artifactId>hotkey-client</artifactId>
  <groupId>com.jd.platform.hotkey</groupId>
  <version>0.0.4-SNAPSHOT</version>
  <scope>system</scope>
  <systemPath>${project.basedir}/lib/hotkey-client-0.0.4-SNAPSHOT.jar</systemPath>
</dependency>
```

ğŸ’¡ æ³¨æ„ï¼Œä½¿ç”¨ `system` ä½œç”¨åŸŸå¹¶ä¸æ˜¯æœ€ä½³å®è·µï¼ŒåŸå› æ˜¯ `system` ä½œç”¨åŸŸçš„ä¾èµ–å…·æœ‰ **æœ€é«˜ä¼˜å…ˆçº§FIczo5HGgjvtA88BeUTE7E7S7QFjIUHX09PfTdM9eBY=**ã€‚å®ƒä¼šè·³è¿‡ Maven çš„ä¾èµ–è§£ææœºåˆ¶ï¼Œç›´æ¥ä½¿ç”¨ä½ æŒ‡å®šçš„æœ¬åœ° JAR æ–‡ä»¶ï¼Œå› æ­¤å®ƒçš„ä¼˜å…ˆçº§ä¼šé«˜äºå…¶ä»–ä»»ä½•æ¥è‡ªä¾èµ–æ ‘ä¸­çš„ä¼ é€’ä¾èµ–æˆ–å¤–å±‚ä¾èµ–å£°æ˜ã€‚5bJnkf2NjukxGeZu9nu4dFFwd0cD9vTlLuEBpCrKUXg=

å…·ä½“æ¥è¯´ï¼š

1. è·³è¿‡ä¾èµ–ç®¡ç†ï¼š`system` ä½œç”¨åŸŸä¼šè·³è¿‡ Maven çš„ä¾èµ–ç®¡ç†å’Œç‰ˆæœ¬è§£æã€‚ä½ å¿…é¡»æ‰‹åŠ¨ç®¡ç†ä¾èµ–ç‰ˆæœ¬å’Œè·¯å¾„ï¼ŒMaven æ— æ³•å¸®ä½ è§£æå†²çªã€å‡çº§ç‰ˆæœ¬æˆ–ä½¿ç”¨ä¼ é€’ä¾èµ–ã€‚
2. æ— æ³•æ’é™¤ä¾èµ–ï¼šç”±äº `system` ä½œç”¨åŸŸæ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä»»ä½•è¯•å›¾é€šè¿‡ `exclusions` æ’é™¤è¿™ä¸ªä¾èµ–çš„å°è¯•éƒ½ä¼šå¤±è´¥ã€‚å…¶ä»–æ¨¡å—æˆ–ä¾èµ–é¡¹ä¸­çš„å†²çªé—®é¢˜ä¹Ÿæ— æ³•é€šè¿‡æ­£å¸¸çš„ `dependencyManagement` æˆ– `exclusions` æœºåˆ¶æ¥è§£å†³ã€‚
3. ä¸å¯ä¼ é€’ï¼š`system` ä½œç”¨åŸŸçš„ä¾èµ–ä¸ä¼šä¼ é€’ç»™å…¶ä»–æ¨¡å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ çš„é¡¹ç›®è¢«å…¶ä»–é¡¹ç›®ä¾èµ–ï¼Œ`system` ä½œç”¨åŸŸçš„ä¾èµ–ä¸ä¼šè‡ªåŠ¨ä¼ é€’ç»™ä¾èµ–ä½ çš„é¡¹ç›®ã€‚è¿™å¯èƒ½å¯¼è‡´æ„å»ºæˆ–è¿è¡Œæ—¶çš„ä¾èµ–é—®é¢˜ã€‚
4. è·¯å¾„ç¡¬ç¼–ç ï¼š`system` ä½œç”¨åŸŸçš„ä¾èµ–è·¯å¾„æ˜¯ç¡¬ç¼–ç çš„ï¼Œå¹¶ä¸”æŒ‡å®šä¸ºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚è¿™ä½¿å¾—é¡¹ç›®åœ¨ä¸åŒå¼€å‘ç¯å¢ƒä¸­å˜å¾—éš¾ä»¥ç§»æ¤ï¼Œä¹Ÿä¸ç¬¦åˆ Maven çš„é€šç”¨ä¾èµ–ç®¡ç†åŸåˆ™ã€‚

æ‰€ä»¥ä¸€èˆ¬å»ºè®®å°†â€ä¾èµ–åŒ…é€šè¿‡ Maven å®‰è£…ï»¿ï¼ˆinstallï¼‰åˆ°æœ¬åœ°ä»“åº“ï»¿ï¼Œæˆ–è€…ä¸Šä¼ åŒ…åˆ° Maven â¢å®˜æ–¹åº“ï¼Œæˆ–è€…åœ¨å›¢é˜Ÿå†…éƒ¨ä½¿ç”¨ â¢Maven ç§æœæ¥ç®¡ç†ä¾èµ–ã€‚

![1754964999845](C:\Users\11860\AppData\Roaming\Typora\typora-user-images\1754964999845.png)

install å®‰è£…åˆ° æœ¬åœ°ä»“åº“ , deployæäº¤åˆ°å›¢é˜Ÿå†…ç§æœ[jaråŒ…ä¸Šä¼ ](https://blog.csdn.net/greatliuda/article/details/125527781?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522ee8d3e2f34dad05777aae303ef8faa8c%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=ee8d3e2f34dad05777aae303ef8faa8c&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-125527781-null-null.142^v102^pc_search_result_base4&utm_term=idea%E8%87%AA%E5%B7%B1%E7%9A%84jar%E5%8C%85%E5%A6%82%E4%BD%95%E6%8F%90%E4%BA%A4%E5%88%B0%E5%9B%A2%E9%98%9F%E5%86%85%E7%9A%84%E7%A7%81%E6%9C%8D&spm=1018.2226.3001.4187)



å¼•å…¥ä¾èµ–åâ€ï¼Œåœ¨ä»£ç ä¸­ç¼–å†™åˆå§‹ï»¿åŒ– client ï»¿çš„é…ç½®ç±»ï¼Œä¼šè¯»å–é…â¢ç½®æ–‡ä»¶å¹¶æ‰§è¡Œåˆå§‹åŒ–â¢é€»è¾‘ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "hotkey")
@Data
public class HotKeyConfig {

    /**
     * Etcd æœåŠ¡å™¨å®Œæ•´åœ°å€
     */
    private String etcdServer = "http://127.0.0.1:2379";

    /**
     * åº”ç”¨åç§°
     */
    private String appName = "app";

    /**
     * æœ¬åœ°ç¼“å­˜æœ€å¤§æ•°é‡
     */
    private int caffeineSize = 10000;

    /**
     * æ‰¹é‡æ¨é€ key çš„é—´éš”æ—¶é—´
     */
    private long pushPeriod = 1000L;

    /**
     * åˆå§‹åŒ– hotkey
     */
    @Bean
    public void initHotkey() {
        ClientStarter.Builder builder = new ClientStarter.Builder();
        ClientStarter starter = builder.setAppName(appName)
                .setCaffeineSize(caffeineSize)
                .setPushPeriod(pushPeriod)
                .setEtcdServer(etcdServer)
                .build();
        starter.startPipeline();
    }
}
```

ğŸ’¡ å¦‚ä½•åœ¨ Spring Boot å¯åŠ¨æ—¶æ‰§è¡Œåˆå§‹åŒ–ä»£ç ï¼Ÿå¯ä»¥å‚è€ƒè¿™é“é¢è¯•é¢˜ï¼š<https://www.mianshiya.com/question/1800329866123747329>



æ›´æ”¹ application.yml é…ç½®ï¼Œæ³¨æ„åº”ç”¨åç§°å¿…é¡»å’Œæ§åˆ¶å°åˆ›å»ºçš„ä¸€è‡´ï¼š

```yaml
# çƒ­ key æ¢æµ‹
hotkey:
  app-name: mianshiya
  caffeine-size: 10000
  push-period: 1000
  etcd-server: http://localhost:2379
```

å¯åŠ¨ï¼Œèƒ½å¤Ÿçœ‹åˆ° 1 ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼š

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/1jz3IE4KOPdkmrZO.webp)



è¿™ä¸ªç±»ä¸»è¦æœ‰å¦‚ä¸‹ 4 ä¸ªæ–¹æ³•å¯ä¾›ä½¿ç”¨ï¼š

```java
boolean JdHotKeyStore.isHotKey(String key)
Object JdHotKeyStore.get(String key)
void JdHotKeyStore.smartSet(String key, Object value)
Object JdHotKeyStore.getValue(String key)
```

```
1ï¼‰boolean isHotKey(String key)vZsSnVHrTg7+wU8S+Y9qyPB2vzU0mKM21yi2Un7X2D8=

è¯¥æ–¹æ³•ä¼šè¿”å›è¯¥ key â€æ˜¯å¦æ˜¯çƒ­ keyï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦‚æœä¸ï»¿æ˜¯è¿”å› falseï¼Œå¹¶ä¸”ä¼šå°† key ä¸ŠæŠ¥åˆ°æ¢ï»¿æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡è®¡ç®—ã€‚è¯¥æ–¹æ³•é€šå¸¸ç”¨äºåˆ¤æ–­åªéœ€è¦åˆ¤â¢æ–­ key æ˜¯å¦çƒ­ã€ä¸éœ€è¦ç¼“å­˜ value çš„â¢åœºæ™¯ï¼Œå¦‚åˆ·å­ç”¨æˆ·ã€æ¥å£è®¿é—®é¢‘ç‡ç­‰ã€‚

2ï¼‰Object get(String key)

è¯¥æ–¹æ³•è¿”å›è¯¥ â€key æœ¬åœ°ç¼“å­˜çš„ valuï»¿e å€¼ï¼Œå¯ç”¨äºåˆ¤æ–­æ˜¯çƒ­ keï»¿y åï¼Œå†å»è·å–æœ¬åœ°ç¼“å­˜çš„ â¢value å€¼ï¼Œé€šå¸¸ç”¨äº râ¢edis çƒ­ key ç¼“å­˜ã€‚LuIckZ71Vcs8G3QaLgjrRk8fQP4i4TjCdPK/OkYnrzI=

3ï¼‰void smartSet(String key, Object value)

æ–¹æ³•ç»™çƒ­ â€key èµ‹å€¼ vaï»¿lueï¼Œå¦‚æœæ˜¯çƒ­ ï»¿keyï¼Œè¯¥æ–¹æ³•æ‰ä¼šâ¢èµ‹å€¼ï¼Œéçƒ­ keyâ¢ï¼Œä»€ä¹ˆä¹Ÿä¸åš

4ï¼‰Object getValue(String key)FIczo5HGgjvtA88BeUTE7E7S7QFjIUHX09PfTdM9eBY=

è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæ•´â€åˆæ–¹æ³•ï¼Œç›¸å½“äº isHotï»¿Key å’Œ get ä¸¤ä¸ªæ–¹ï»¿æ³•çš„æ•´åˆï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›æœ¬â¢åœ°ç¼“å­˜çš„ valueã€‚ å¦‚â¢æœæ˜¯çƒ­ keyï¼Œåˆ™å­˜åœ¨ä¸¤ç§æƒ…å†µ

1. æ˜¯è¿”å› value
2. æ˜¯è¿”å› null

è¿”å› null æ˜¯å› ä¸ºâ€å°šæœªç»™å®ƒ set çœŸæ­£çš„ valueï¼Œè¿”å›ï»¿é null è¯´æ˜å·²ç»è°ƒç”¨è¿‡ set æ–¹æ³•ï»¿äº†ï¼Œæœ¬åœ°ç¼“å­˜ value æœ‰å€¼äº†ã€‚ å¦‚æœä¸â¢æ˜¯çƒ­ keyï¼Œåˆ™è¿”å› nullï¼Œå¹¶ä¸”å°† kâ¢ey ä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡æ¢æµ‹ã€‚
```



**å®˜æ–¹æ¨èçš„æœ€ä½³å®è·µ**

1ï¼‰åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯åˆ·å­ï¼š

```java
if (JdHotKeyStore.isHotKey(â€œpin__â€ + thePin)) {
    // è¿›è¡Œé™æµ
}
```

2ï¼‰åˆ¤æ–­å•†å“ id æ˜¯å¦æ˜¯çƒ­ç‚¹ï¼š

```java
Object skuInfo = JdHotKeyStore.getValue("skuId__" + skuId);
if(skuInfo == null) {
    JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);
} else {
    // ä½¿ç”¨ç¼“å­˜å¥½çš„ value å³å¯
}
```

æ¨èè¿™ç§å†™æ³•ï¼Œæ›´åŠ æ¸…æ™°ï¼š

```java
if (JdHotKeyStore.isHotKey(key)) {
    //æ³¨æ„æ˜¯getï¼Œä¸æ˜¯getValueã€‚getValueä¼šè·å–å¹¶ä¸ŠæŠ¥ï¼Œgetæ˜¯çº¯ç²¹çš„æœ¬åœ°è·å–
    Object skuInfo = JdHotKeyStore.get("skuId__" + skuId);
    if(skuInfo == null) {
        JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);
    } else {
        //ä½¿ç”¨ç¼“å­˜å¥½çš„valueå³å¯
    }
}
```

**é…ç½® hotkey è§„åˆ™**

æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåˆ¤æ–­ `bank_detail_` å¼€å¤´çš„ keyï¼Œå¦‚æœ 5 ç§’è®¿é—® 10 æ¬¡ï¼Œå°±ä¼šè¢«æ¨é€åˆ° jvm å†…å­˜ä¸­ï¼Œå°†è¿™ä¸ªçƒ­ key ç¼“å­˜ 10 åˆ†é’Ÿã€‚DmljR0S6epZLwTKT+A4BXoKO5kbb2VqHAfTiB03Nees=

å¯¹åº”çš„è§„åˆ™é…ç½®å¦‚ä¸‹ï¼š

```json
[
    {
        "duration": 600,
        "key": "bank_detail_",
        "prefix": true,
        "interval": 5,
        "threshold": 10,
        "desc": "çƒ­é—¨é¢˜åº“ç¼“å­˜"
    }
]
```

### 6.é™æµå’Œç†”æ–­

æ¦‚å¿µ

1ã€æµé‡æ§åˆ¶

æµé‡æ§åˆ¶æ˜¯ä¸ºäº† **é˜²æ­¢ç³»ç»Ÿè¢«è¿‡å¤šçš„è¯·æ±‚å‹å®**

- é™æµï¼šé€šè¿‡å›ºå®šçª—å£ã€ä»¤ç‰Œæ¡¶æˆ–æ¼æ¡¶ç­‰ç®—æ³•é™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°é‡ã€‚
- æ’é˜Ÿï¼šå½“è¯·æ±‚é‡è¶…å‡ºå¤„ç†èƒ½åŠ›æ—¶ï¼Œéƒ¨åˆ†è¯·æ±‚è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé˜²æ­¢ç«‹å³è¶…è½½ã€‚

2ã€ç†”æ–­æœºåˆ¶

ç†”æ–­æœºåˆ¶çš„ç›®çš„æ˜¯ **é¿å…å½“ä¸‹æ¸¸æœåŠ¡å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿç»§ç»­è€—è´¹èµ„æºé‡å¤å‘èµ·å¤±è´¥è¯·æ±‚**

3ã€é™çº§æœºåˆ¶

æä¾›ç®€åŒ–ç‰ˆçš„åŠŸèƒ½æˆ–è¿”å›é»˜è®¤å€¼ä½œä¸º **å…œåº•**

4ã€ç†”æ–­å’Œé™çº§çš„åŒºåˆ«

- ç†”æ–­æ˜¯å½“æœåŠ¡å¥åº·çŠ¶å†µæ¶åŒ–æ—¶ï¼Œé€šè¿‡ **åˆ‡æ–­è°ƒç”¨** é¿å…ç³»ç»Ÿèµ„æºæµªè´¹æˆ–æœåŠ¡é—´æ•…éšœæ‰©æ•£ã€‚
- é™çº§æ˜¯åœ¨ç³»ç»Ÿå‹åŠ›è¿‡å¤§æˆ–æŸä¸ªæœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œé€šè¿‡ **æä¾›ç®€åŒ–çš„æ›¿ä»£æ–¹æ¡ˆ** ï¼Œä¿æŒç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚



### 7.Sentinel

å¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/dashboard.html) è¿›è¡Œå®‰è£…ã€‚

1ï¼‰ä¸‹è½½æ§åˆ¶å° jar åŒ…å¹¶åœ¨æœ¬åœ°å¯åŠ¨ï¼Œå¯ä»¥è®¿é—®ä» [github](https://github.com/alibaba/Sentinel/releases) ä¸Šä¸‹è½½ releaseçš„ jar åŒ…ã€‚

2ï¼‰ç›´æ¥åœ¨å‘½ä»¤è¡Œçª—å£å¯åŠ¨ Sentinel æ§åˆ¶å°ï¼š

æ³¨æ„ï¼šå¯åŠ¨â€ Sentinelï»¿ æ§åˆ¶å°éœ€è¦ JDï»¿K ç‰ˆæœ¬ä¸º 1.8â¢ åŠä»¥ä¸Šç‰ˆæœ¬ã€‚

```java
java -Dserver.port=8131 -jar sentinel-dashboard-1.8.6.jar
```

è®¿é—® <http://localhost:8131/ï¼ˆä½ å¡«çš„ç«¯å£ï¼‰ï¼Œå³å¯è®¿é—®æ§åˆ¶å°ï¼Œ**é»˜è®¤è´¦å·å’Œå¯†ç éƒ½æ˜¯> sentinel

3ï¼‰å®¢æˆ·ç«¯æ¥å…¥æ§åˆ¶å°

```xml
<dependency>
  <groupId>com.alibaba.csp</groupId>
  <artifactId>sentinel-transport-simple-http</artifactId>
  <version>1.8.6</version>
</dependency>
```

ç¨‹åºå¯åŠ¨æ—¶éœ€è¦åŠ å…¥ JVM å‚æ•° `-Dcsp.sentinel.dashboard.server=consoleIp:port` æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£ã€‚è‹¥å¯åŠ¨å¤šä¸ªåº”ç”¨ï¼Œåˆ™éœ€è¦é€šè¿‡ `-Dcsp.sentinel.api.port=xxxx` æŒ‡å®šå®¢æˆ·ç«¯ç›‘æ§ API çš„ç«¯å£ï¼ˆé»˜è®¤æ˜¯ 8719ï¼‰ã€‚

æ­¤å¤„ç›´æ¥è¿è¡Œ Main æ–¹æ³•æ¥æ¼”ç¤ºæ•ˆæœï¼ŒJVM å‚æ•°ä¸ºï¼š`-Dcsp.sentinel.dashboard.server=localhost:8131`

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/TlkE2He3jihoi9ov.webp)

**ç¡®ä¿å®¢æˆ·ç«¯æœ‰è®¿é—®é‡**ï¼ŒSentinel ä¼šåœ¨ **å®¢æˆ·ç«¯é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™** è¿›è¡Œåˆå§‹åŒ–ï¼Œå¼€å§‹å‘æ§åˆ¶å°å‘é€å¿ƒè·³åŒ…ã€‚é€šè¿‡æ§åˆ¶å°å¯ä»¥æŸ¥çœ‹åˆ°å®æ—¶è®¿é—®æƒ…å†µï¼š

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/NAwAxcOiQxQ1bPwQ.webp)

**è¿™äº›è§„åˆ™ä»…åœ¨å†…å­˜æ€ç”Ÿæ•ˆï¼Œåº”ç”¨é‡å¯ä¹‹åï¼Œè¯¥è§„åˆ™ä¼šä¸¢å¤±ã€‚**

åœ¨ç”Ÿäº§ç¯å¢ƒâ€ä¸­ï¼Œå®˜æ–¹æ¨è pusï»¿h æ¨¡å¼ , å¯ä»¥pushåˆ°nacosæˆ–è€…Zookeeper



**æ•´åˆSpringBootä½¿ç”¨**

å»ºè®® [å‚è€ƒå®˜æ–¹æ–‡æ¡£é€‰æ‹©ç‰ˆæœ¬](https://github.com/alibaba/spring-cloud-alibaba/wiki/ç‰ˆæœ¬è¯´æ˜)ã€‚

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/Xggn6dT88LlQk5ek.webp)

```xml
<!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-sentinel -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    <version>2021.0.5.0</version>
</dependency>
```

**é€šè¿‡æ³¨è§£å®šä¹‰èµ„æº**

å®ç°é™æµé˜»å¡å’Œç†”æ–­é™çº§æ–¹æ³•ã€‚æ³¨æ„éµå¾ª [å®˜æ–¹æ–‡æ¡£çš„æ–¹æ³•å®šä¹‰è§„åˆ™](https://sentinelguard.io/zh-cn/docs/annotation-support.html)ï¼š

```java
public class TestService {

    // å¯¹åº”çš„ `handleException` å‡½æ•°éœ€è¦ä½äº `ExceptionUtil` ç±»ä¸­ï¼Œå¹¶ä¸”å¿…é¡»ä¸º static å‡½æ•°.
    @SentinelResource(value = "test", blockHandler = "handleException", blockHandlerClass = {ExceptionUtil.class})
    public void test() {
        System.out.println("Test");
    }

    // åŸå‡½æ•°
    @SentinelResource(value = "hello", blockHandler = "exceptionHandler", fallback = "helloFallback")
    public String hello(long s) {
        return String.format("Hello at %d", s);
    }
    
    // Fallback å‡½æ•°ï¼Œå‡½æ•°ç­¾åä¸åŸå‡½æ•°ä¸€è‡´æˆ–åŠ ä¸€ä¸ª Throwable ç±»å‹çš„å‚æ•°.
    public String helloFallback(long s) {
        return String.format("Halooooo %d", s);
    }

    // Block å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå‚æ•°æœ€åå¤šä¸€ä¸ª BlockExceptionï¼Œå…¶ä½™ä¸åŸå‡½æ•°ä¸€è‡´.
    public String exceptionHandler(long s, BlockException ex) {
        // Do some log here.
        ex.printStackTrace();
        return "Oops, error occurred at " + s;
    }
}
```

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/jVa23HsnqNl6X6sv.webp)



**å®šä¹‰è§„åˆ™ï¼š**Sentinelæ”¯æŒé€šè¿‡ä»£ç ã€æ§åˆ¶å°ï¼ˆæ¨èï¼‰ã€é…ç½®æ–‡ä»¶æ¥å®šä¹‰è§„åˆ™ã€‚

æ¯”å¦‚é€šè¿‡ä»£ç å®šä¹‰ä¸€ä¸ªé™æµè§„åˆ™ï¼Œæ›´çµæ´»ï¼š

```java
private static void initFlowQpsRule() {
    List<FlowRule> rules = new ArrayList<>();
    FlowRule rule1 = new FlowRule();
    rule1.setResource(resource);
    // Set max qps to 20
    rule1.setCount(20);
    rule1.setGrade(RuleConstant.FLOW_GRADE_QPS);
    rule1.setLimitApp("default");
    rules.add(rule1);
    FlowRuleManager.loadRules(rules);
}
```



**åˆ·é¢˜å¹³å°çš„ä»£ç ç¤ºä¾‹ ,  é€šè¿‡ç¼–ç æ–¹å¼å®šä¹‰è§„åˆ™**

```java
try {
    entry = SphU.entry("listQuestionVOByPage", EntryType.IN, 1, remoteAddr);
    // è¢«ä¿æŠ¤çš„ä¸šåŠ¡é€»è¾‘
    // æŸ¥è¯¢æ•°æ®åº“
    Page<Question> questionPage = questionService.listQuestionByPage(questionQueryRequest);
    // è·å–å°è£…ç±»
    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));
} catch (Throwable ex) {
    // ä¸šåŠ¡å¼‚å¸¸
    if (!BlockException.isBlockException(ex)) {
        Tracer.trace(ex);
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }
    // é™çº§æ“ä½œ
    if (ex instanceof DegradeException) {
        return handleFallback(questionQueryRequest, request, ex);
    }
    // é™æµæ“ä½œ
    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
} finally {
    if (entry != null) {
        entry.exit(1, remoteAddr);
    }
}

/**
 * listQuestionVOByPage é™çº§æ“ä½œï¼šç›´æ¥è¿”å›æœ¬åœ°æ•°æ®
 */
public BaseResponse<Page<QuestionVO>> handleFallback(QuestionQueryRequest questionQueryRequest,
                                                         HttpServletRequest request, Throwable ex) {
    // å¯ä»¥è¿”å›æœ¬åœ°æ•°æ®æˆ–ç©ºæ•°æ®
    return ResultUtils.success(null);
}
```



```java
@Component
public class SentinelRulesManager {

    @PostConstruct
    public void initRules() {
        initFlowRules();
        initDegradeRules();
    }

    // é™æµè§„åˆ™
    public void initFlowRules() {
        // å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨é™æµè§„åˆ™
        ParamFlowRule rule = new ParamFlowRule("listQuestionVOByPage")
                .setParamIdx(0) // å¯¹ç¬¬ 0 ä¸ªå‚æ•°é™æµï¼Œå³ IP åœ°å€
                .setCount(60) // æ¯åˆ†é’Ÿæœ€å¤š 60 æ¬¡
                .setDurationInSec(60); // è§„åˆ™çš„ç»Ÿè®¡å‘¨æœŸä¸º 60 ç§’
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));
    }

    // é™çº§è§„åˆ™
    public void initDegradeRules() {
        // å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨ç†”æ–­è§„åˆ™
        DegradeRule slowCallRule = new DegradeRule("listQuestionVOByPage")
                .setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType())
                .setCount(0.2) // æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äº 20%
                .setTimeWindow(60) // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’
                .setStatIntervalMs(30 * 1000) // ç»Ÿè®¡æ—¶é•¿ 30 ç§’
                .setMinRequestAmount(10) // æœ€å°è¯·æ±‚æ•°
                .setSlowRatioThreshold(3); // å“åº”æ—¶é—´è¶…è¿‡ 3 ç§’

        DegradeRule errorRateRule = new DegradeRule("listQuestionVOByPage")
                .setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType())
                .setCount(0.1) // å¼‚å¸¸ç‡å¤§äº 10%
                .setTimeWindow(60) // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’
                .setStatIntervalMs(30 * 1000) // ç»Ÿè®¡æ—¶é•¿ 30 ç§’
                .setMinRequestAmount(10); // æœ€å°è¯·æ±‚æ•°

        // åŠ è½½è§„åˆ™
        DegradeRuleManager.loadRules(Arrays.asList(slowCallRule, errorRateRule));
    }
}
```

### 8.åŸºäºnacos åŠ å¸ƒéš†è¿‡æ»¤å™¨ å®ç°å…¨å±€é»‘åå•æ‹¦æˆª

**åˆ›å»ºé»‘åå•è¿‡æ»¤å·¥å…·ç±»**



å¯ä»¥ç”¨ Hutool æˆ– Guava åº“è‡ªå¸¦çš„ bloomfilterï¼Œ[å‚è€ƒæ–‡ç« ](https://blog.csdn.net/asd051377305/article/details/139684962)ï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼ï¼Œè¿˜å¯ä»¥è€ƒè™‘ Redissonã€‚

æ­¤å¤„ç”±äºé¡¹â€ç›®å·²ç»ä½¿ç”¨äº† Huï»¿tool å·¥å…·åº“ï¼Œï»¿å°±ç”¨å…¶è‡ªå¸¦çš„ Biâ¢tMapBloomâ¢Filter å³å¯ã€‚

```java
@Slf4j
public class BlackIpUtils {

    private static BitMapBloomFilter bloomFilter;

    // åˆ¤æ–­ ip æ˜¯å¦åœ¨é»‘åå•å†…
    public static boolean isBlackIp(String ip) {
        return bloomFilter.contains(ip);
    }

    // é‡å»º ip é»‘åå•
    public static void rebuildBlackIp(String configInfo) {
        if (StrUtil.isBlank(configInfo)) {
            configInfo = "{}";
        }
        // è§£æ yaml æ–‡ä»¶
        Yaml yaml = new Yaml();
        Map map = yaml.loadAs(configInfo, Map.class);
        // è·å– ip é»‘åå•
        List<String> blackIpList = (List<String>) map.get("blackIpList");
        // åŠ é”é˜²æ­¢å¹¶å‘
        synchronized (BlackIpUtils.class) {
            if (CollectionUtil.isNotEmpty(blackIpList)) {
                // æ³¨æ„æ„é€ å‚æ•°çš„è®¾ç½®
                BitMapBloomFilter bitMapBloomFilter = new BitMapBloomFilter(958506);
                for (String ip : blackIpList) {
                    bitMapBloomFilter.add(ip);
                }
                bloomFilter = bitMapBloomFilter;
            } else {
                bloomFilter = new BitMapBloomFilter(100);
            }
        }
    }
}
```

**Nacos é…ç½®ç›‘å¬ç±»**

å¯ä»¥ç›´æ¥é€šè¿‡ Nacos æ§åˆ¶å°è·å–ç¤ºä¾‹ä»£ç ï¼š

![img](https://pic.code-nav.cn/course_picture/1601072287388278786/Klw11YF8zKoCSS02.webp)

```java
@Slf4j
@Component
public class NacosListener implements InitializingBean {

    @NacosInjected
    private ConfigService configService;

    @Value("${nacos.config.data-id}")
    private String dataId;

    @Value("${nacos.config.group}")
    private String group;

    @Override
    public void afterPropertiesSet() throws Exception {
        log.info("nacos ç›‘å¬å™¨å¯åŠ¨");

        String config = configService.getConfigAndSignListener(dataId, group, 3000L, new Listener() {
            final ThreadFactory threadFactory = new ThreadFactory() {
                private final AtomicInteger poolNumber = new AtomicInteger(1);
                @Override
                public Thread newThread(@NotNull Runnable r) {
                    Thread thread = new Thread(r);
                    thread.setName("refresh-ThreadPool" + poolNumber.getAndIncrement());
                    return thread;
                }
            };
            final ExecutorService executorService = Executors.newFixedThreadPool(1, threadFactory);

            // é€šè¿‡çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†é»‘åå•å˜åŒ–çš„é€»è¾‘
            @Override
            public Executor getExecutor() {
                return executorService;
            }

            // ç›‘å¬åç»­é»‘åå•å˜åŒ–
            @Override
            public void receiveConfigInfo(String configInfo) {
                log.info("ç›‘å¬åˆ°é…ç½®ä¿¡æ¯å˜åŒ–ï¼š{}", configInfo);
                BlackIpUtils.rebuildBlackIp(configInfo);
            }
        });
        // åˆå§‹åŒ–é»‘åå•
        BlackIpUtils.rebuildBlackIp(config);
    }
}
```

**åˆ›å»ºé»‘åå•è¿‡æ»¤å™¨**

é»‘åå•åº”è¯¥å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿâ€æ•ˆï¼ˆä¸æ­¢æ˜¯ Controller çš„æ¥å£ï¼‰ï¼Œï»¿æ‰€ä»¥åŸºäº WebFilter å®ç°è€Œä¸æ˜¯ Aï»¿OP åˆ‡é¢ã€‚WebFilter çš„ä¼˜å…ˆçº§é«˜äºâ¢ @Aspect åˆ‡é¢ï¼Œå› ä¸ºå®ƒåœ¨æ•´ä¸ª Webâ¢ è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­æ›´æ—©è¿›è¡Œå¤„ç†ã€‚

```
è¯·æ±‚è¿›å…¥æ—¶çš„é¡ºåºï¼š

- WebFilterï¼šé¦–å…ˆï¼ŒWebFilter æ‹¦æˆª HTTP è¯·æ±‚ï¼Œå¹¶å¯ä»¥æ ¹æ®é€»è¾‘å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚
- Spring AOP åˆ‡é¢ï¼ˆ@Aspectï¼‰ï¼šå¦‚æœè¯·æ±‚ç»è¿‡è¿‡æ»¤å™¨å¹¶è¿›å…¥ Spring ç®¡ç†çš„ Beanï¼ˆä¾‹å¦‚ Controller å±‚ï¼‰ï¼Œæ­¤æ—¶åˆ‡é¢ç”Ÿæ•ˆï¼Œå¯¹åŒ¹é…çš„ Bean æ–¹æ³•è¿›è¡Œæ‹¦æˆªã€‚
- Controller å±‚ï¼šå¦‚æœ @Aspect æ²¡æœ‰é˜»æ­¢æ‰§è¡Œï¼Œæœ€ç»ˆè¯·æ±‚åˆ°è¾¾ @Controller æˆ– @RestController çš„æ–¹æ³•ã€‚
```

```java
@WebFilter(urlPatterns = "/*", filterName = "blackIpFilter")
public class BlackIpFilter implements Filter {

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        String ipAddress = NetUtils.getIpAddress((HttpServletRequest) servletRequest);
        if (BlackIpUtils.isBlackIp(ipAddress)) {
            servletResponse.setContentType("text/json;charset=UTF-8");
            servletResponse.getWriter().write("{\"errorCode\":\"-1\",\"errorMsg\":\"é»‘åå•IPï¼Œç¦æ­¢è®¿é—®\"}");
            return;
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }

}
```

éœ€è¦åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š `@ServletComponentScan`ï¼Œè¿™æ ·è¿‡æ»¤å™¨æ‰ä¼šè¢«æ‰«æåˆ°ã€‚